<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ghostline ‚Äì Creative Intelligence System</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/loader.css">
  <script src="/static/main.js" defer></script>
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <style>
    /* Bottom-fixed composer */
    .composer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0b0b0b;
      border-top: 1px solid #303030;
      padding: 10px 12px;
      z-index: 20;
    }
    .composer form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .composer textarea {
      flex: 1;
      min-height: 54px;
      max-height: 160px;
      background: #111;
      color: #eee;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 12px;
      resize: vertical;
    }
    .composer .submit {
      padding: 8px 16px;
      background: #6A0DAD;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }
    header .bar { display: flex; align-items: center; gap: 12px; justify-content: space-between; }
    header .left { display: flex; align-items: center; gap: 12px; }
    header h1 { margin: 0; }
    /* Chat thread */
    .thread { display: flex; flex-direction: column; gap: 10px; padding: 0 8px 140px 8px; }
    .msg { display: flex; }
    .msg.right { justify-content: flex-end; }
    .bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #3b3b3b;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .bubble.user { background: #1f2937; border-color: #374151; }
    .bubble.bot { background: #111827; border-color: #4b5563; }
    .role { font-weight: 700; opacity: 0.85; margin-bottom: 4px; }
  /* --- Mobile-friendly chat layout --- */
:root{
  /* fallbacks; JS keeps these in sync with real sizes */
  --header-h: 72px;
  --composer-h: 150px;
}

/* Chat area uses dynamic viewport to play nice with mobile browser chrome */
main.chat{
  height: calc(100dvh - var(--header-h));
  overflow: hidden; /* thread handles its own scroll */
}

/* Thread scrolls and leaves room for the composer */
.thread{
  height: calc(100% - var(--composer-h));
  overflow: auto;
  padding: 8px 8px calc(var(--composer-h) + 16px) 8px; /* extra bottom so last msg isn‚Äôt hidden */
}

/* Composer respects notches/home-indicator on iOS */
.composer{
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

/* --- Tighten on small screens --- */
@media (max-width: 600px){
  .composer{ padding: 8px; }
  .composer form{
    flex-direction: column;
    align-items: stretch;
  }
  .composer label{ margin-top: 6px; }
  .composer textarea{
    min-height: 80px;
    width: 100%;
  }
  .composer select,
  .composer .submit,
  .composer input[type="file"],
  .composer input[type="submit"],
  .composer button{
    width: 100%;
  }
  .composer div{
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
}

	</style>
</head>

<body class="dark-mode">
  <header>
    <div class="bar">
      <div class="left">
        <img src="/static/syntax-buffering.png" alt="Syntax Prime Logo" width="64" style="vertical-align: middle;">
        <h1>Ghostline</h1>
      </div>

      <!-- Logout button with confirm -->
      <form action="{{ url_for('logout') }}" method="get" id="logoutForm" style="display:inline;">
        <button type="submit"
                aria-label="Log out"
                title="Log out"
                style="background-color:#333; color:#fff; padding:6px 12px; border:none; border-radius:8px; cursor:pointer;">
          üö® Logout
        </button>
      </form>
    </div>

    <p style="margin-top:6px; font-style:italic; font-size:0.9rem; color:#ccc;">
      Syntax Prime is online. Minimal patience. Maximum sarcasm.
    </p>
  </header>

  <!-- Thinking / loader -->
  <div id="loader">
    <img src="/static/syntax-buffering.png" alt="Syntax Prime buffering..." width="100"><br>
    Syntax Prime is buffering your next poor decision‚Ä¶
  </div>

  <!-- Threaded chat -->
  <main class="chat">
    <div class="thread" id="thread">
      {% if conversation and conversation|length > 0 %}
        {% set display_names = {'SyntaxPrime':'Syntax Prime','SyntaxBot':'SyntaxBot','Nil.exe':'Nil.exe','GhadaGPT':'GhadaGPT'} %}

        {% for turn in conversation %}
          <!-- User -->
          <div class="msg right">
            <div class="bubble user">
              <div class="role">You</div>
              <div>{{ turn.user | e }}</div>
            </div>
          </div>

          <!-- Assistant replies -->
          {% for voice, reply in turn.responses.items() %}
            <div class="msg">
              <div class="bubble bot">
                <div class="role">{{ display_names.get(voice, voice) }}</div>
                <div>{{ reply | e }}</div>
              </div>
            </div>
          {% endfor %}
        {% endfor %}
      {% else %}
        <div class="msg">
          <div class="bubble bot">
            <div class="role">Syntax Prime</div>
            <div>Say something and I‚Äôll talk back. Try ‚ÄúWhat day is it?‚Äù</div>
          </div>
        </div>
      {% endif %}
    </div>
  </main>

  <!-- Bottom-fixed composer -->
  <div class="composer">
    <form method="POST">
      <label for="project">üìÇ Project:</label>
      <select name="project">
        {% for project in projects %}
          <option value="{{ project }}" {% if project == current_project %}selected{% endif %}>{{ project }}</option>
        {% endfor %}
      </select>

      <label for="user_input">üí¨ Prompt:</label>
      <textarea name="user_input" required placeholder="Type your prompt... (Enter to send, Shift+Enter for newline)"></textarea>

      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <span>ü§ñ Who responds?</span>
        <label><input type="checkbox" name="voices" value="SyntaxPrime" checked> Syntax Prime</label>
        <label><input type="checkbox" name="voices" value="SyntaxBot"> SyntaxBot</label>
        <label><input type="checkbox" name="voices" value="Nil.exe"> Nil.exe</label>
        <label><input type="checkbox" name="voices" value="GhadaGPT"> GhadaGPT</label>
        <label><input type="checkbox" name="random"> üé≤ Random</label>
        <button class="submit" type="submit">Submit</button>
      </div>
    </form>

    <!-- Upload / OCR -->
    <form action="/upload" method="post" enctype="multipart/form-data" style="margin-top:10px;">
      <label for="file">Upload Image or Document:</label>
      <input type="file" name="file">
      <input type="submit" value="Analyze"
             style="margin-left:10px; padding:6px 12px; background-color:#6A0DAD; color:#fff; border:none; border-radius:6px; cursor:pointer;">
    </form>

    <!-- Export -->
    <form id="exportForm" style="margin-top:10px;">
      <button type="submit"
              style="padding:6px 12px; background-color:#333; color:#fff; border:none; border-radius:6px; cursor:pointer;">
        üì§ Export Session
      </button>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    // Submit on Enter (Shift+Enter for newline)
    const ta = document.querySelector('textarea[name="user_input"]');
    if (ta) {
      ta.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.form.submit();
        }
      });
    }

    // Export current project
    document.getElementById('exportForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const proj = document.querySelector('select[name="project"]').value;
      window.location.href = '/export/' + encodeURIComponent(proj);
    });

    // Confirm logout
    const lf = document.getElementById('logoutForm');
    if (lf) {
      lf.addEventListener('submit', function (e) {
        if (!confirm('Log out of Ghostline?\nYou‚Äôll need the password to log back in.')) {
          e.preventDefault();
        }
      });
    }

    // Auto-scroll to latest message
    const thread = document.getElementById('thread');
    if (thread) thread.scrollTop = thread.scrollHeight;
  </script>
	<script>
  // keep CSS vars in sync with real header/composer sizes
  function updateHeights(){
    const header = document.querySelector('header');
    const composer = document.querySelector('.composer');
    if(header) document.documentElement.style.setProperty('--header-h', header.offsetHeight + 'px');
    if(composer) document.documentElement.style.setProperty('--composer-h', composer.offsetHeight + 'px');
    // nudge thread to the bottom after size changes
    const thread = document.getElementById('thread');
    if(thread) thread.scrollTop = thread.scrollHeight;
  }
  window.addEventListener('load', updateHeights);
  window.addEventListener('resize', updateHeights);
  new ResizeObserver(updateHeights).observe(document.querySelector('.composer'));

  // auto-resize textarea + keep it visible when keyboard opens
  const ta = document.querySelector('textarea[name="user_input"]');
  if (ta){
    const fit = () => {
      ta.style.height = 'auto';
      ta.style.height = Math.min(220, ta.scrollHeight) + 'px';
    };
    ta.addEventListener('input', fit);
    ta.addEventListener('focus', () => {
      setTimeout(() => {
        fit();
        const thread = document.getElementById('thread');
        if(thread) thread.scrollTop = thread.scrollHeight;
      }, 100);
    });
    fit();
  }

  // (kept) Enter-to-send behavior
  if (ta) {
    ta.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.form.submit();
      }
    });
  }
</script>

</body>
</html>
